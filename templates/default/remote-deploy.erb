#!/bin/sh
<%= @header %>
<%
# SSH port forwarding
#
# Arguments:
# -N do not execute remote command
# -f requests ssh to go to background before command execution
# -R bind_address : bind_port : host_address : host_port
# remote login
#
ra = node['rails_app']['deploy']['remote_bind_address']
rl = node['rails_app']['deploy']['remote_login']
@mapping.each do |host_port, remote_port| -%>

CMD="ssh -N -f -R <%= ra %>:<%= remote_port %>:localhost:<%= host_port %> <%= rl %>"
pgrep -f -x "$CMD" > /dev/null 2>&1 || su -c "$CMD" jeeves
<% end -%>
